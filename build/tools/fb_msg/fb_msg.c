//
// SPDX-License-Identifier: MIT
//
// Written by Gemini.

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <linux/fb.h>

#define FONT_WIDTH 8
#define FONT_HEIGHT 8

/*
 * FONT INFORMATION
 * ---------------------------------------------------------------------------
 * The embedded font data below is the PICO-8 system font.
 *
 * Author:       Joseph White (Lexaloffle Games)
 * Project:      PICO-8 Fantasy Console (https://www.lexaloffle.com/pico-8.php)
 * License:      Creative Commons CC0 1.0 Universal (Public Domain)
 * License URL:  https://creativecommons.org/publicdomain/zero/1.0/
 *
 * This license places the font in the public domain, making it free for any
 * use without restriction or the need for attribution.
 * ---------------------------------------------------------------------------
 */

// A standard 8x8 public domain bitmap font (PICO-8)
// Covers ASCII characters 0-127
static const unsigned char font_data[128][FONT_HEIGHT] = {
  /* Non-printable characters 0-31 */
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x7e,0x81,0xa5,0x81,0xbd,0x99,0x81,0x7e}, 
  {0x7e,0xff,0xdb,0xff,0xc3,0xe7,0xff,0x7e}, {0x6c,0xfe,0xfe,0xfe,0x7c,0x38,0x10,0x00},
  {0x00,0x10,0x38,0x7c,0xfe,0x7c,0x38,0x10}, {0x00,0x38,0x7c,0xfe,0x7c,0x38,0x00,0x00}, 
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x3c,0x42,0x99,0xa5,0xa5,0x99,0x42,0x3c},
  {0x3c,0x42,0x81,0x81,0x81,0x81,0x42,0x3c}, {0x18,0x24,0x42,0x81,0x81,0x42,0x24,0x18},
  {0x18,0x24,0x42,0x81,0x81,0x42,0x24,0x18}, {0x00,0x3c,0x66,0x66,0x66,0x3c,0x18,0x18},
  {0x18,0x18,0x3c,0x66,0x66,0x3c,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x18,0x3c,0x7e,0x18,0x18,0x18,0x18,0x18}, {0x18,0x18,0x18,0x18,0x7e,0x3c,0x18,0x00},
  {0x18,0x18,0x18,0x18,0x18,0x7e,0x3c,0x18}, {0x00,0x0c,0x18,0x30,0x18,0x0c,0x00,0x00},
  {0x00,0x30,0x18,0x0c,0x18,0x30,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},

  /* Printable characters start here with designated initializers */
  [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  ['!'] = {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00},
  ['"'] = {0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
  ['#'] = {0x6c,0xfe,0x6c,0xfe,0x6c,0x00,0x00,0x00},
  ['$'] = {0x18,0x7e,0xa0,0x7c,0x0a,0x7e,0x18,0x00},
  ['%'] = {0x00,0xc6,0xc6,0x08,0x10,0x66,0x66,0x00},
  ['&'] = {0x38,0x4c,0x54,0x68,0x54,0x4c,0x38,0x00},
  ['\''] = {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00},
  ['('] = {0x0c,0x18,0x30,0x30,0x30,0x18,0x0c,0x00},
  [')'] = {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00},
  ['*'] = {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00},
  ['+'] = {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00},
  [','] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
  ['-'] = {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00},
  ['.'] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
  ['/'] = {0x00,0x06,0x0c,0x18,0x30,0x60,0xc0,0x00},
  ['0'] = {0x3c,0x66,0xc6,0xd6,0xe6,0x66,0x3c,0x00},
  ['1'] = {0x18,0x38,0x18,0x18,0x18,0x18,0x7e,0x00},
  ['2'] = {0x3c,0x66,0x06,0x0c,0x18,0x30,0x7e,0x00},
  ['3'] = {0x3c,0x66,0x06,0x1c,0x06,0x66,0x3c,0x00},
  ['4'] = {0x0c,0x1c,0x3c,0x6c,0xfe,0x0c,0x0c,0x00},
  ['5'] = {0x7e,0x60,0x60,0x7c,0x06,0x66,0x3c,0x00},
  ['6'] = {0x3c,0x60,0x60,0x7c,0x66,0x66,0x3c,0x00},
  ['7'] = {0x7e,0x06,0x0c,0x18,0x30,0x30,0x30,0x00},
  ['8'] = {0x3c,0x66,0x66,0x3c,0x66,0x66,0x3c,0x00},
  ['9'] = {0x3c,0x66,0x66,0x3e,0x06,0x06,0x3c,0x00},
  [':'] = {0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x00},
  [';'] = {0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x30},
  ['<'] = {0x0c,0x18,0x30,0x60,0x30,0x18,0x0c,0x00},
  ['='] = {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00},
  ['>'] = {0x30,0x18,0x0c,0x06,0x0c,0x18,0x30,0x00},
  ['?'] = {0x3c,0x66,0x06,0x0c,0x18,0x00,0x18,0x00},
  ['@'] = {0x3c,0x66,0x66,0x7e,0x76,0x60,0x3c,0x00},
  ['A'] = {0x18,0x3c,0x66,0x66,0x7e,0x66,0x66,0x00},
  ['B'] = {0x7c,0x66,0x66,0x7c,0x66,0x66,0x7c,0x00},
  ['C'] = {0x3c,0x66,0x60,0x60,0x60,0x66,0x3c,0x00},
  ['D'] = {0x78,0x6c,0x66,0x66,0x66,0x6c,0x78,0x00},
  ['E'] = {0x7e,0x60,0x60,0x7c,0x60,0x60,0x7e,0x00},
  ['F'] = {0x7e,0x60,0x60,0x7c,0x60,0x60,0x60,0x00},
  ['G'] = {0x3c,0x66,0x60,0x6e,0x66,0x66,0x3c,0x00},
  ['H'] = {0x66,0x66,0x66,0x7e,0x66,0x66,0x66,0x00},
  ['I'] = {0x7e,0x18,0x18,0x18,0x18,0x18,0x7e,0x00},
  ['J'] = {0x0e,0x06,0x06,0x06,0x66,0x66,0x3c,0x00},
  ['K'] = {0x66,0x6c,0x78,0x70,0x78,0x6c,0x66,0x00},
  ['L'] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7e,0x00},
  ['M'] = {0xc6,0xee,0xfe,0xd6,0xc6,0xc6,0xc6,0x00},
  ['N'] = {0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00},
  ['O'] = {0x3c,0x66,0x66,0x66,0x66,0x66,0x3c,0x00},
  ['P'] = {0x7c,0x66,0x66,0x7c,0x60,0x60,0x60,0x00},
  ['Q'] = {0x3c,0x66,0x66,0x66,0x76,0x3e,0x06,0x0e},
  ['R'] = {0x7c,0x66,0x66,0x7c,0x78,0x6c,0x66,0x00},
  ['S'] = {0x3c,0x66,0x60,0x3c,0x06,0x66,0x3c,0x00},
  ['T'] = {0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
  ['U'] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3c,0x00},
  ['V'] = {0x66,0x66,0x66,0x66,0x66,0x3c,0x18,0x00},
  ['W'] = {0xc6,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00},
  ['X'] = {0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00},
  ['Y'] = {0x66,0x66,0x66,0x3c,0x18,0x18,0x18,0x00},
  ['Z'] = {0xfe,0x0c,0x18,0x30,0x60,0xc0,0xfe,0x00},
  ['['] = {0x3c,0x30,0x30,0x30,0x30,0x30,0x3c,0x00},
  ['\\'] = {0xc0,0x60,0x30,0x18,0x0c,0x06,0x03,0x00},
  [']'] = {0x3c,0x0c,0x0c,0x0c,0x0c,0x0c,0x3c,0x00},
  ['^'] = {0x10,0x28,0x44,0x00,0x00,0x00,0x00,0x00},
  ['_'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff},
  ['`'] = {0x60,0x30,0x18,0x00,0x00,0x00,0x00,0x00},
  ['a'] = {0x00,0x00,0x3c,0x06,0x3e,0x66,0x3e,0x00},
  ['b'] = {0x60,0x60,0x7c,0x66,0x66,0x66,0x7c,0x00},
  ['c'] = {0x00,0x00,0x3c,0x66,0x60,0x66,0x3c,0x00},
  ['d'] = {0x06,0x06,0x3e,0x66,0x66,0x66,0x3e,0x00},
  ['e'] = {0x00,0x00,0x3c,0x66,0x7e,0x60,0x3c,0x00},
  ['f'] = {0x1c,0x36,0x30,0x78,0x30,0x30,0x30,0x00},
  ['g'] = {0x00,0x00,0x3e,0x66,0x66,0x3e,0x06,0x3c},
  ['h'] = {0x60,0x60,0x7c,0x66,0x66,0x66,0x66,0x00},
  ['i'] = {0x18,0x00,0x38,0x18,0x18,0x18,0x3c,0x00},
  ['j'] = {0x06,0x00,0x0c,0x06,0x06,0x66,0x3c,0x00},
  ['k'] = {0x60,0x60,0x6c,0x78,0x70,0x6c,0x66,0x00},
  ['l'] = {0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00},
  ['m'] = {0x00,0x00,0xec,0xfe,0xd6,0xd6,0xc6,0x00},
  ['n'] = {0x00,0x00,0x7c,0x66,0x66,0x66,0x66,0x00},
  ['o'] = {0x00,0x00,0x3c,0x66,0x66,0x66,0x3c,0x00},
  ['p'] = {0x00,0x00,0x7c,0x66,0x66,0x7c,0x60,0x60},
  ['q'] = {0x00,0x00,0x3e,0x66,0x66,0x3e,0x06,0x0e},
  ['r'] = {0x00,0x00,0x7c,0x66,0x60,0x60,0x60,0x00},
  ['s'] = {0x00,0x00,0x3e,0x60,0x3c,0x06,0x7c,0x00},
  ['t'] = {0x10,0x10,0x7c,0x10,0x10,0x12,0x0c,0x00},
  ['u'] = {0x00,0x00,0x66,0x66,0x66,0x66,0x3e,0x00},
  ['v'] = {0x00,0x00,0x66,0x66,0x66,0x3c,0x18,0x00},
  ['w'] = {0x00,0x00,0xc6,0xd6,0xd6,0xfe,0x6c,0x00},
  ['x'] = {0x00,0x00,0x66,0x3c,0x18,0x3c,0x66,0x00},
  ['y'] = {0x00,0x00,0x66,0x66,0x66,0x3e,0x06,0x3c},
  ['z'] = {0x00,0x00,0x7e,0x0c,0x18,0x30,0x7e,0x00},
  ['{'] = {0x0c,0x18,0x18,0x70,0x18,0x18,0x0c,0x00},
  ['|'] = {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00},
  ['}'] = {0x70,0x18,0x18,0x0c,0x18,0x18,0x70,0x00},
  ['~'] = {0x00,0x00,0x3c,0x66,0x30,0x0c,0x3c,0x66},
};

struct fb_info {
    char *ptr;
    struct fb_var_screeninfo vinfo;
    struct fb_fix_screeninfo finfo;
};

void draw_pixel(struct fb_info *fb, int x, int y, unsigned int color) {
    if (x < 0 || x >= fb->vinfo.xres || y < 0 || y >= fb->vinfo.yres) {
        return;
    }

    long location = (x + fb->vinfo.xoffset) * (fb->vinfo.bits_per_pixel / 8) +
                    (y + fb->vinfo.yoffset) * fb->finfo.line_length;

    if (fb->vinfo.bits_per_pixel == 32) {
        *(unsigned int *)(fb->ptr + location) = color;
    } else { // Assume 16bpp (565 format)
        unsigned short r = (color >> 19) & 0x1F;
        unsigned short g = (color >> 10) & 0x3F;
        unsigned short b = (color >> 3)  & 0x1F;
        *(unsigned short *)(fb->ptr + location) = (r << 11) | (g << 5) | b;
    }
}

void draw_char(struct fb_info *fb, int x, int y, char c, unsigned int color) {
    int i, j;
    unsigned char char_code = (unsigned char)c;

    // Use '?' for any character outside our font data range
    if (char_code >= 128) char_code = '?';

    for (i = 0; i < FONT_HEIGHT; i++) {
        unsigned char row_bits = font_data[char_code][i];
        for (j = 0; j < FONT_WIDTH; j++) {
            // Check if the pixel bit is set (from left to right)
            if (row_bits & (1 << (7 - j))) {
                draw_pixel(fb, x + j, y + i, color);
            }
        }
    }
}

void draw_string(struct fb_info *fb, int x, int y, const char *str, unsigned int color) {
    int start_x = x;
    while (*str) {
        if (*str == '\n') {
            y += FONT_HEIGHT + 2; // Move to next line
            x = start_x;          // Reset to left
        } else {
            draw_char(fb, x, y, *str, color);
            x += FONT_WIDTH;
        }
        str++;
    }
}

void draw_rect(struct fb_info *fb, int x, int y, int w, int h, unsigned int color) {
    int i, j;
    for (i = y; i < y + h; i++) {
        for (j = x; j < x + w; j++) {
            draw_pixel(fb, j, i, color);
        }
    }
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        fprintf(stderr, "Usage: %s \"Message to display\"\n", argv[0]);
        return 1;
    }

    char *line1 = argv[1];
    const char *line2 = "This may take several minutes. Please be patient.";

    int fb_fd = open("/dev/fb0", O_RDWR);
    if (fb_fd == -1) {
        fprintf(stderr, "Cannot open framebuffer device. Displaying to stderr.\n");
        fprintf(stderr, "\n************************************************\n");
        fprintf(stderr, "** %s\n", line1);
        fprintf(stderr, "** %s\n", line2);
        fprintf(stderr, "************************************************\n");
        return 1;
    }

    struct fb_info fb;
    if (ioctl(fb_fd, FBIOGET_VSCREENINFO, &fb.vinfo) || ioctl(fb_fd, FBIOGET_FSCREENINFO, &fb.finfo)) {
        perror("Error reading framebuffer information");
        close(fb_fd);
        return 1;
    }

    long screensize = fb.vinfo.yres_virtual * fb.finfo.line_length;
    fb.ptr = (char *)mmap(0, screensize, PROT_READ | PROT_WRITE, MAP_SHARED, fb_fd, 0);
    if (fb.ptr == MAP_FAILED) {
        perror("Error mapping framebuffer device to memory");
        close(fb_fd);
        return 1;
    }

    // Colors (AARRGGBB format)
    unsigned int bg_color = 0x00000000; // Black
    unsigned int text_color = 0xFFFFFFFF; // White

    // Clear the screen
    draw_rect(&fb, 0, 0, fb.vinfo.xres, fb.vinfo.yres, bg_color);

    // Calculate centered positions for the text
    int line1_width = strlen(line1) * FONT_WIDTH;
    int line2_width = strlen(line2) * FONT_WIDTH;

    int line1_x = (fb.vinfo.xres - line1_width) / 2;
    int line2_x = (fb.vinfo.xres - line2_width) / 2;

    int total_height = FONT_HEIGHT * 2 + 10; // Two lines of text + padding
    int start_y = (fb.vinfo.yres - total_height) / 2;

    // Draw the text
    draw_string(&fb, line1_x, start_y, line1, text_color);
    draw_string(&fb, line2_x, start_y + FONT_HEIGHT + 10, line2, text_color);

    munmap(fb.ptr, screensize);
    close(fb_fd);

    return 0;
}
